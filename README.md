# Setting up TLS ELK Stack

This docker-compose project will assist with setting up and creating a ELK stack using generated TLS certificates for communications.  Basically, you get HTTPS for all services.  

> Currently we encrypt communications between services but I plan on adding TLS authentication as an option in the near future.

This project was built so that we could test and use built-in features undert Kibana SIEM, like detections, signals, cases, etc.

This docker-compose project will create the following Elastic containers based on version 7.8.1:

* Elasticsearch
* Logstash
* Kibana
* Packetbeat
* Filebeat

## Setup

In order to use this project, you must first include the following in a [.env](.env) file:

```text
ELK_VERSION=7.8.1
ELASTIC_USERNAME="elastic"
ELASTIC_PASSWORD="some_password"

# Configuration Variables
ELASTICSEARCH_HEAP="2g"
LOGSTASH_HEAP="1g"
PACKETBEAT_HEAP="256m"
FILEBEAT_HEAP="256m"
XPACK_ENCRYPTION_KEY="somesuperlongstringlikethisoneMQBbtsynu4bV2uxLy"

# Self signed TLS certificates
CA_PASSWORD="some password"
CA_DN="CN=Elastic Certificate Tool Autogenerated CA"
CA_DAYS=3650
ELASTIC_DIR=/usr/share/elasticsearch
LOGSTASH_DIR=/usr/share/logstash
KIBANA_DIR=/usr/share/kibana
PACKETBEAT_DIR=/usr/share/packetbeat
FILEBEAT_DIR=/usr/share/filebeat
```

### Keystore

Before we build or create our containers we first need to create our keystore and certificates.  You can do this using the [docker-compose.setup.yml](docker-compose.setup.yml) yaml file.  If you run into issues you can see the associated documentation [CERTIFICATES.md](CERTIFICATES.md) or create an issue in this repository.

```bash
docker-compose -f docker-compose.setup.yml run --rm certs
```

Once you run this yaml file, you should have all necessary certificates/keys.  Next (recommended) you can set passwords for all accounts within ELK but this is optional and it it will use the default password defined in your `.env` file under the `ELASTIC_PASSWORD` value.

### Setting Passwords (optional)

The first thing you will is set passwords for all accounts within ELK.

Let's run our ELK stack now:

```
docker-compose up -d
```

#### Set Passwords

You will need to set passwords for all accounts.  I recommend in a tesitng environment to create a single password and use this across all accounts - it makes it easier when troublehshooting.

We need to access the elasticsearch container and generate our passwords:

```
docker-compose exec elasticsearch bash
> bin/elasticsearch-setup-passwords interactive -u "https://0.0.0.0:9200"
# Set passwords for all accounts when prompted
```

## Running ELK Stack

Now, that you have your keys/certs and passwords set we can then just restart the containers by running:

```
docker-compose up -d
```

You should be able to login into the ELK stack and be on your way.

Below is a map of common services and their IPs/Ports created by this docker-compose project:

|Service      |Protocol    | IP Address | Port(s)   |
|-------------|------------|------------|-----------|
|Elasticsearch|https       |0.0.0.0     |9200, 9300 |
|Logstash     |udp         |0.0.0.0     |12201, 5000|
|Logstash     |tcp         |0.0.0.0     |5000       |
|Logstash     |http        |0.0.0.0     |5044, 9600 |
|Kibana       |https       |0.0.0.0     |5601       |
|Packetbeat   |http        |0.0.0.0     |Will capture local traffic|
|Filebeat     |tcp         |0.0.0.0     |9000       |


## Additional Notes

This section provides some traditional situations that may arise and how to handle them:

* When trying to access Kibana for the first time, it may take several minutes for you to receive a response.  If Kibana is working, you should see `server not up yet` when access the Kibana UI.  
* Since we are generating self-signed certificates you may get a browser warning (especially Chrome) that the site is unsafe. If you select `continue` you may not be able to until you type `thisisunsafe` while the tab is selected.  There is not place to enter this information, you actually just type it in and it will trust this certificate for this browser session.

## Enabling features

This section talks about enabling features within Kibana and the Security stack.  In order to use all the features (mostly dashboards and reports) within Kibana SIEM you may have to modify your index mappings.

### Create & Modify Index Mappings

As an example you can use the provided Python script [modify_index_mappings.py](bin/modify_index_mappings.py) to create a new (or modify an existing) elasticsearch index and modify its mappings to support features/UI components within the Elastic Kibana SIEM feature set.

### Loading pre-packaged rules

To access or load elastic's pre-packaged signals (detection rules) you can run the following after creating the default space above.

```python
import requests
from requests.auth import HTTPBasicAuth

_HOST = 'https://0.0.0.0:5601'
_USERNAME = 'elastic'
_PASSWORD = 'some_password'

headers = {
    'kbn-xsrf': 'elk-tls-docker',
    'Content-Type': 'application/json'
}

ENDPOINT = '/api/detection_engine/rules/prepackaged'

response = requests.put(
    _HOST + ENDPOINT, 
    headers=headers, 
    auth=HTTPBasicAuth(_USERNAME, _PASSWORD), 
    verify=False)
print(response.json())
```

## Adding Data to Kibana

Now we need to add some data.  You can do this the traditional way by just configuring all your systems to point to Logstash or Elasticsearch or Kibana or you can use a few shortcuts :)

I am providing two different shortcuts.  The first is using a project I wrote called `soc-faker` and the other is sending data directly to the `filebeat` service. You can find them both below:

* [Generate Fake Elasticsearch Documents using soc-faker](bin/send_document_to_elasticsearch.py)
* [Send raw strings to filebeat using sockets](bin/send_data_to_filebeat.py)

## Built With

* [carcass](https://github.com/MSAdministrator/carcass) - Python packaging template

## Contributing

Please read [CONTRIBUTING.md](CONTRIBUTING.md) for details on our code of conduct, and the process for submitting pull requests to us.

## Versioning

We use [SemVer](http://semver.org/) for versioning. 

## Change Log

Please read [CHANGELOG.md](CHANGELOG.md) for details on features for a specific version of `elk-tls-docker`

## Authors

* Josh Rickard - *Initial work* - [MSAdministrator](https://github.com/msadministrator)

See also the list of [contributors](https://github.com/swimlane/elk-tls-docker/contributors) who participated in this project.

## License

This project is licensed under the MIT License - see the [LICENSE](LICENSE.md) file for details
